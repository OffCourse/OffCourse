service: public-badges

custom:
  registry_bucket: public-badges-registry-${opt:stage}
  api: public-badges.api
  save_organization: public-badges.save-organization

provider:
  name: aws
  runtime: nodejs10.x
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
      Resource: "arn:aws:s3:::${self:custom.registry_bucket}/*"
    - Effect: Allow
      Action:
        - events:PutEvents
      Resource: "*"

functions:
  graphql:
    handler: dist/index.graphql
    events:
      - http:
          path: graphql
          method: post
          cors: true
      - http:
          path: graphql
          method: get
          cors: true
      - http:
          path: playground
          method: any
          cors: true
    environment:
      REGISTRY_BUCKET: ${self:custom.registry_bucket}
      HANDLER_NAME: ${self:custom.api}
  saveOrganization:
    handler: dist/index.saveOrganization
    events:
      - eventBridge:
          pattern:
            source:
              - ${self:custom.api}
            detail-type: ["ORGANIZATION_REGISTRATION_REQUESTED"]
    environment:
      REGISTRY_BUCKET: ${self:custom.registry_bucket}
      HANDLER_NAME: ${self:custom.save_organization}
  echo:
    handler: dist/index.echo
    events:
      - eventBridge:
          pattern:
            source:
              - ${self:custom.save_organization}
            detail-type: ["ORGANIZATION_APPROVAL_REQUESTED"]
    environment:
      HANDLER_NAME: public-badges.echo
  indexer:
    handler: dist/index.approve
    events:
      - s3: ${self:custom.registry_bucket}
    environment:
      HANDLER_NAME: public-badges.indexer
